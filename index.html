<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üïâÔ∏è Divine Sample Size Calculator by Karmayogi</title>
    <style>
        :root {
            --primary: #FF7722;
            --primary-dark: #E65D00;
            --primary-light: #FFB380;
            --secondary: #138808;
            --accent: #FF9933;
            --success: #008000;
            --warning: #FFD700;
            --error: #FF0000;
            --bg-gradient: linear-gradient(135deg, #FF9933, #138808);
            --card-bg: #ffffff;
            --text: #1F1F1F;
            --text-light: #666666;
            --border: #E5E5E5;
            --border-focus: #FF9933;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            min-height: 100vh;
            background: var(--bg-gradient);
            color: var(--text);
            line-height: 1.6;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .header {
            background: var(--bg-gradient);
            padding: 2rem;
            text-align: center;
            color: white;
            position: relative;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            position: relative;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .study-selector {
            padding: 2rem;
            background: white;
        }

        .study-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        /* Part 1A ends here - Next part continues with more CSS */
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üïâÔ∏è Divine Sample Size Calculator üïâÔ∏è</h1>
            <p>Calculate with divine precision and clarity</p>
        </div>

        <div class="study-selector">
            <h2>Select Your Study Type</h2>
            <div class="study-grid" id="studyButtons">
                <button class="study-btn" data-type="descriptive">
                    üìä Descriptive Study
                </button>
                <button class="study-btn" data-type="comparative">
                    üîÑ Comparative Study
                </button>
                <button class="study-btn" data-type="case-control">
                    üéØ Case-Control Study
                </button>
                <button class="study-btn" data-type="cohort">
                    üë• Cohort Study
                </button>
                <button class="study-btn" data-type="clinical">
                    üíä Clinical Trial
                </button>
                <button class="study-btn" data-type="diagnostic">
                    üîç Diagnostic Study
                </button>
            </div>
        </div>

        <div id="calculatorForm" class="calculator-form">
            <!-- Dynamic form will be inserted here -->
        </div>

        <div id="results" class="results"></div>

        <div class="footer">
            <p>Made with <span class="heart">‚ù§Ô∏è</span> by Karmayogi</p>
            <p>üïâÔ∏è ‡§ú‡§Ø ‡§∂‡•ç‡§∞‡•Ä ‡§∞‡§æ‡§Æ üïâÔ∏è</p>
        </div>
    </div>

<!-- Part 1A ends here - Next part continues with CSS and begins JavaScript -->
<style>
    .study-btn {
        padding: 1.5rem;
        border: 2px solid var(--primary);
        border-radius: 12px;
        background: white;
        color: var(--primary);
        font-weight: 600;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .study-btn:hover, .study-btn.active {
        background: var(--primary);
        color: white;
        transform: translateY(-3px);
        box-shadow: var(--shadow-hover);
    }

    .calculator-form {
        padding: 2rem;
        display: none;
    }

    .calculator-form.active {
        display: block;
        animation: fadeIn 0.5s ease-out;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1.5rem;
    }

    .input-group {
        margin-bottom: 1.5rem;
    }

    .input-label {
        display: flex;
        align-items: center;
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .input-field {
        width: 100%;
        padding: 0.875rem 1rem;
        border: 2px solid var(--border);
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(255, 153, 51, 0.2);
    }

    .calculate-btn {
        background: var(--primary);
        color: white;
        padding: 1rem 2rem;
        border: none;
        border-radius: 10px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin: 2rem auto;
        min-width: 200px;
    }

    .calculate-btn:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: var(--shadow-hover);
    }

    .results {
        padding: 2rem;
        display: none;
    }

    .results.active {
        display: block;
        animation: slideUp 0.5s ease-out;
    }

    .result-card {
        background: linear-gradient(to bottom right, #fff9f0, #fff);
        border-radius: 15px;
        padding: 2rem;
        box-shadow: var(--shadow);
        margin-bottom: 1.5rem;
        border: 2px solid var(--primary-light);
    }

    .error {
        color: var(--error);
        background: #ffe6e6;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        display: none;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .heart {
        color: #FF0000;
        display: inline-block;
        animation: heartbeat 1.5s ease infinite;
    }

    @keyframes heartbeat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.2); }
    }
</style>

<script>
// Core Calculator Class
class SampleSizeCalculator {
    constructor() {
        this.initialize();
        this.setupEventListeners();
        this.currentStudyType = null;
    }

    initialize() {
        this.formContainer = document.getElementById('calculatorForm');
        this.resultsContainer = document.getElementById('results');
        this.errorContainer = document.createElement('div');
        this.errorContainer.className = 'error';
        this.formContainer.appendChild(this.errorContainer);
    }

    setupEventListeners() {
        document.querySelectorAll('.study-btn').forEach(button => {
            button.addEventListener('click', () => {
                this.handleStudySelection(button);
            });
        });
    }

    handleStudySelection(button) {
        this.clearAll();
        document.querySelectorAll('.study-btn').forEach(btn => 
            btn.classList.remove('active'));
        button.classList.add('active');
        this.currentStudyType = button.dataset.type;
        this.generateForm();
    }

    clearAll() {
        this.formContainer.innerHTML = '';
        this.resultsContainer.innerHTML = '';
        this.resultsContainer.classList.remove('active');
    }

    generateForm() {
        const form = document.createElement('form');
        form.id = `${this.currentStudyType}Form`;
        form.innerHTML = this.getFormContent();
        form.onsubmit = (e) => {
            e.preventDefault();
            this.calculateSampleSize();
        };

        this.formContainer.innerHTML = '';
        this.formContainer.appendChild(form);
        this.formContainer.classList.add('active');
        this.setupFormBehavior();
    }

    // Utility methods for calculations
    getZScore(confidence) {
        const alpha = (100 - confidence) / 100;
        return Math.abs(this.normalQuantile(alpha/2));
    }

    normalQuantile(p) {
        if (p < 0 || p > 1) {
            throw new Error('Invalid probability value');
        }

        if (p === 0) return Number.NEGATIVE_INFINITY;
        if (p === 1) return Number.POSITIVE_INFINITY;

        const a0 = 2.50662823884;
        const a1 = -18.61500062529;
        const a2 = 41.39119773534;
        const a3 = -25.44106049637;
        const b1 = -8.47351093090;
        const b2 = 23.08336743743;
        const b3 = -21.06224101826;
        const b4 = 3.13082909833;

        const q = p - 0.5;
        
        if (Math.abs(q) <= 0.425) {
            const r = 0.180625 - q * q;
            return q * (((((a3 * r + a2) * r + a1) * r + a0))) /
                   (((((b4 * r + b3) * r + b2) * r + b1) * r + 1));
        }

        const r = p < 0.5 ? p : 1 - p;
        const s = Math.log(-Math.log(r));
        let t = a0 + s * (a1 + s * (a2 + s * a3));
        t = t / (b1 + s * (b2 + s * (b3 + s * b4)));
        
        return p < 0.5 ? -t : t;
    }

    showError(message) {
        this.errorContainer.textContent = message;
        this.errorContainer.style.display = 'block';
        setTimeout(() => {
            this.errorContainer.style.display = 'none';
        }, 5000);
    }

    // Part 1B ends here - Next part continues with study-specific methods
   // Core form content selection method
    getFormContent() {
        switch(this.currentStudyType) {
            case 'descriptive':
                return this.getDescriptiveForm();
            case 'comparative':
                return this.getComparativeForm();
            case 'case-control':
                return this.getCaseControlForm();
            case 'cohort':
                return this.getCohortForm();
            case 'clinical':
                return this.getClinicalTrialForm();
            case 'diagnostic':
                return this.getDiagnosticStudyForm();
            default:
                return '<p>Please select a study type</p>';
        }
    }

    setupFormBehavior() {
        switch(this.currentStudyType) {
            case 'descriptive':
                this.setupDescriptiveBehavior();
                break;
            case 'comparative':
                this.setupComparativeBehavior();
                break;
            case 'case-control':
                this.setupCaseControlBehavior();
                break;
            case 'cohort':
                this.setupCohortBehavior();
                break;
            case 'clinical':
                this.setupClinicalTrialBehavior();
                break;
            case 'diagnostic':
                this.setupDiagnosticBehavior();
                break;
        }
    }

    calculateSampleSize() {
        try {
            let results;
            switch(this.currentStudyType) {
                case 'descriptive':
                    results = this.calculateDescriptiveSampleSize();
                    break;
                case 'comparative':
                    results = this.calculateComparativeSampleSize();
                    break;
                case 'case-control':
                    results = this.calculateCaseControlSampleSize();
                    break;
                case 'cohort':
                    results = this.calculateCohortSampleSize();
                    break;
                case 'clinical':
                    results = this.calculateClinicalTrialSampleSize();
                    break;
                case 'diagnostic':
                    results = this.calculateDiagnosticSampleSize();
                    break;
                default:
                    throw new Error('Invalid study type');
            }
            this.displayResults(results);
        } catch (error) {
            this.showError(error.message);
        }
    }

    displayResults(results) {
        switch(this.currentStudyType) {
            case 'descriptive':
                this.displayDescriptiveResults(results);
                break;
            case 'comparative':
                this.displayComparativeResults(results);
                break;
            case 'case-control':
                this.displayCaseControlResults(results);
                break;
            case 'cohort':
                this.displayCohortResults(results);
                break;
            case 'clinical':
                this.displayClinicalTrialResults(results);
                break;
            case 'diagnostic':
                this.displayDiagnosticResults(results);
                break;
        }
        this.resultsContainer.classList.add('active');
    }
getDescriptiveForm() {
        return `
            <h3>Descriptive Study Calculator</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Study Parameter
                        <span class="tooltip" title="Choose your primary outcome measure">‚ÑπÔ∏è</span>
                    </label>
                    <select id="parameterType" class="input-field" required>
                        <option value="">Select Parameter Type</option>
                        <option value="proportion">Proportion/Percentage</option>
                        <option value="mean">Mean (Average)</option>
                    </select>
                </div>

                <div id="proportionInputs" style="display:none;">
                    <div class="input-group">
                        <label>Expected Proportion
                            <span class="tooltip" title="Expected proportion in population (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="proportion" class="input-field" 
                               step="0.01" min="0" max="1" placeholder="e.g., 0.5">
                    </div>
                </div>

                <div id="meanInputs" style="display:none;">
                    <div class="input-group">
                        <label>Expected Mean
                            <span class="tooltip" title="Expected population mean">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="mean" class="input-field" step="any">
                    </div>
                    <div class="input-group">
                        <label>Expected Standard Deviation
                            <span class="tooltip" title="Expected population standard deviation">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="stdDev" class="input-field" min="0" step="any">
                    </div>
                </div>

                <div class="input-group">
                    <label>Margin of Error
                        <span class="tooltip" title="Acceptable error margin (as decimal)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="marginError" class="input-field" 
                           value="0.05" step="0.01" min="0.01" max="0.99" required>
                </div>

                <div class="input-group">
                    <label>Confidence Level (%)
                        <span class="tooltip" title="Desired confidence level">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="confidenceLevel" class="input-field" 
                           value="95" min="1" max="99" required>
                </div>

                <div class="input-group">
                    <label>Known Population Size (Optional)
                        <span class="tooltip" title="Total population size (if known)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="populationSize" class="input-field" min="1">
                </div>

                <div class="input-group">
                    <label>Design Effect
                        <span class="tooltip" title="Adjustment for complex sampling (‚â•1)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="designEffect" class="input-field" 
                           value="1" min="1" step="0.1" required>
                </div>
            </div>
            <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
        `;
    }

    setupDescriptiveBehavior() {
        const parameterType = document.getElementById('parameterType');
        const proportionInputs = document.getElementById('proportionInputs');
        const meanInputs = document.getElementById('meanInputs');
        
        if (parameterType) {
            parameterType.addEventListener('change', () => {
                if (parameterType.value === 'proportion') {
                    proportionInputs.style.display = 'block';
                    meanInputs.style.display = 'none';
                    document.getElementById('proportion').required = true;
                    document.getElementById('mean').required = false;
                    document.getElementById('stdDev').required = false;
                } else if (parameterType.value === 'mean') {
                    proportionInputs.style.display = 'none';
                    meanInputs.style.display = 'block';
                    document.getElementById('proportion').required = false;
                    document.getElementById('mean').required = true;
                    document.getElementById('stdDev').required = true;
                }
            });
        }
    }

  calculateDescriptiveSampleSize() {
    // Get and validate inputs
    const parameterType = document.getElementById('parameterType').value;
    const marginError = parseFloat(document.getElementById('marginError').value);
    const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
    const designEffect = parseFloat(document.getElementById('designEffect').value);
    const populationSize = document.getElementById('populationSize').value ? 
        parseInt(document.getElementById('populationSize').value) : null;

    // Input validation
    this.validateDescriptiveInputs({
        marginError,
        confidenceLevel,
        designEffect,
        populationSize
    });

    // Get Z-score for confidence level
    const zScore = this.getZScore(confidenceLevel);
    let baseSize, adjustedSize;

    if (parameterType === 'proportion') {
        const proportion = parseFloat(document.getElementById('proportion').value);
        
        if (isNaN(proportion) || proportion < 0 || proportion > 1) {
            throw new Error('Proportion must be between 0 and 1');
        }

        // Step 1: Calculate initial sample size without design effect
        baseSize = this.calculateForProportion(proportion, marginError, zScore);
        
        // Step 2: Apply design effect
        const sizeWithDesignEffect = Math.ceil(baseSize * designEffect);
        
        // Step 3: Apply finite population correction if applicable
        adjustedSize = populationSize ? 
            this.applyFinitePopulationCorrection(sizeWithDesignEffect, populationSize) :
            sizeWithDesignEffect;

    } else if (parameterType === 'mean') {
        const mean = parseFloat(document.getElementById('mean').value);
        const stdDev = parseFloat(document.getElementById('stdDev').value);
        
        if (isNaN(stdDev) || stdDev <= 0) {
            throw new Error('Standard deviation must be greater than 0');
        }

        // Calculate for means
        baseSize = this.calculateForMean(stdDev, marginError, zScore);
        adjustedSize = Math.ceil(baseSize * designEffect);
        
        if (populationSize) {
            adjustedSize = this.applyFinitePopulationCorrection(adjustedSize, populationSize);
        }
    }

    return {
        baseSize: Math.ceil(baseSize),
        adjustedSize: Math.ceil(adjustedSize),
        parameterType,
        confidenceLevel,
        marginError: marginError * 100,
        designEffect,
        populationSize
    };
}

validateDescriptiveInputs(inputs) {
    const { marginError, confidenceLevel, designEffect, populationSize } = inputs;
    const errors = [];

    if (!marginError || marginError <= 0 || marginError >= 1) {
        errors.push('Margin of error must be between 0 and 1');
    }

    if (!confidenceLevel || confidenceLevel <= 0 || confidenceLevel >= 100) {
        errors.push('Confidence level must be between 0 and 100');
    }

    if (!designEffect || designEffect < 1) {
        errors.push('Design effect must be 1 or greater');
    }

    if (populationSize !== null && (populationSize <= 0 || !Number.isInteger(populationSize))) {
        errors.push('Population size must be a positive integer');
    }

    if (errors.length > 0) {
        throw new Error(errors.join('\n'));
    }
}

calculateForProportion(proportion, marginError, zScore) {
    // Formula: n‚ÇÄ = Z¬≤ √ó p √ó (1-p) / d¬≤
    const q = 1 - proportion;
    
    // Calculate with high precision
    const numerator = Math.pow(zScore, 2) * proportion * q;
    const denominator = Math.pow(marginError, 2);
    
    // Round up to ensure sufficient sample size
    return Math.ceil(numerator / denominator);
}

calculateForMean(stdDev, marginError, zScore) {
    // Formula: n = (Z √ó œÉ / E)¬≤
    return Math.ceil(Math.pow(zScore * stdDev / marginError, 2));
}

applyFinitePopulationCorrection(sampleSize, populationSize) {
    // Formula: n = n‚ÇÄ / (1 + ((n‚ÇÄ - 1) / N))
    if (!populationSize || populationSize <= 0) return sampleSize;
    
    const correctedSize = sampleSize / (1 + ((sampleSize - 1) / populationSize));
    return Math.ceil(correctedSize);
}

displayDescriptiveResults(results) {
    const resultHTML = `
        <div class="result-card">
            <h3>Sample Size Results</h3>
            <div class="result-section">
                <h4>Required Sample Sizes</h4>
                <p><strong>Final Sample Size:</strong> ${results.adjustedSize}</p>
                <p><strong>Initial Sample Size:</strong> ${results.baseSize}</p>
                
                <h4>Study Parameters</h4>
                <p><strong>Parameter Type:</strong> ${results.parameterType === 'proportion' ? 'Proportion' : 'Mean'}</p>
                <p><strong>Confidence Level:</strong> ${results.confidenceLevel}%</p>
                <p><strong>Margin of Error:</strong> ¬±${results.marginError}%</p>
                
                <h4>Adjustments Applied</h4>
                ${results.designEffect !== 1 ? 
                    `<p><strong>Design Effect:</strong> ${results.designEffect}</p>` : ''}
                ${results.populationSize ? 
                    `<p><strong>Population Size:</strong> ${results.populationSize} (Finite population correction applied)</p>` : ''}
            </div>
            
            <div class="result-section">
                <h4>Interpretation</h4>
                <p>This sample size will allow estimation of the population ${results.parameterType} with:</p>
                <ul>
                    <li>¬±${results.marginError}% margin of error</li>
                    <li>${results.confidenceLevel}% confidence level</li>
                    ${results.populationSize ? 
                        `<li>Adjusted for finite population of ${results.populationSize}</li>` : ''}
                    ${results.designEffect !== 1 ? 
                        `<li>Adjusted for design effect of ${results.designEffect}</li>` : ''}
                </ul>
            </div>
        </div>
    `;
    this.resultsContainer.innerHTML = resultHTML;
}
    // Part 2 ends here - Next part will implement Comparative Study methods
  // Comparative Study Methods
    getComparativeForm() {
        return `
            <h3>Comparative Study Calculator</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Comparison Type
                        <span class="tooltip" title="Select type of comparison">‚ÑπÔ∏è</span>
                    </label>
                    <select id="comparisonType" class="input-field" required>
                        <option value="">Select Comparison Type</option>
                        <option value="means">Compare Means</option>
                        <option value="proportions">Compare Proportions</option>
                    </select>
                </div>

                <div id="meansInputs" style="display:none;">
                    <div class="input-group">
                        <label>Mean of Group 1
                            <span class="tooltip" title="Expected mean for first group">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="mean1" class="input-field" step="any">
                    </div>
                    <div class="input-group">
                        <label>Mean of Group 2
                            <span class="tooltip" title="Expected mean for second group">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="mean2" class="input-field" step="any">
                    </div>
                    <div class="input-group">
                        <label>Common Standard Deviation
                            <span class="tooltip" title="Expected standard deviation (same for both groups)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="commonStdDev" class="input-field" min="0" step="any">
                    </div>
                </div>

                <div id="proportionsInputs" style="display:none;">
                    <div class="input-group">
                        <label>Proportion in Group 1
                            <span class="tooltip" title="Expected proportion in first group (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="prop1" class="input-field" 
                               step="0.01" min="0" max="1">
                    </div>
                    <div class="input-group">
                        <label>Proportion in Group 2
                            <span class="tooltip" title="Expected proportion in second group (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="prop2" class="input-field" 
                               step="0.01" min="0" max="1">
                    </div>
                </div>

                <div class="input-group">
                    <label>Significance Level (Œ±)
                        <span class="tooltip" title="Type I error rate (typically 0.05)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="alpha" class="input-field" 
                           value="0.05" step="0.01" min="0.01" max="0.1" required>
                </div>

                <div class="input-group">
                    <label>Power (1-Œ≤)
                        <span class="tooltip" title="Statistical power (typically 0.8 or 0.9)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="power" class="input-field" 
                           value="0.8" step="0.05" min="0.5" max="0.99" required>
                </div>

                <div class="input-group">
                    <label>Allocation Ratio (n2/n1)
                        <span class="tooltip" title="Ratio of group sizes (1 for equal groups)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="allocationRatio" class="input-field" 
                           value="1" min="0.1" step="0.1" required>
                </div>
            </div>
            <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
        `;
    }

    setupComparativeBehavior() {
        const comparisonType = document.getElementById('comparisonType');
        const meansInputs = document.getElementById('meansInputs');
        const proportionsInputs = document.getElementById('proportionsInputs');

        if (comparisonType) {
            comparisonType.addEventListener('change', () => {
                if (comparisonType.value === 'means') {
                    meansInputs.style.display = 'block';
                    proportionsInputs.style.display = 'none';
                    ['mean1', 'mean2', 'commonStdDev'].forEach(id => 
                        document.getElementById(id).required = true);
                    ['prop1', 'prop2'].forEach(id => 
                        document.getElementById(id).required = false);
                } else if (comparisonType.value === 'proportions') {
                    meansInputs.style.display = 'none';
                    proportionsInputs.style.display = 'block';
                    ['mean1', 'mean2', 'commonStdDev'].forEach(id => 
                        document.getElementById(id).required = false);
                    ['prop1', 'prop2'].forEach(id => 
                        document.getElementById(id).required = true);
                }
            });
        }
    }

    calculateComparativeSampleSize() {
        const type = document.getElementById('comparisonType').value;
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        const ratio = parseFloat(document.getElementById('allocationRatio').value);

        const zAlpha = this.getZScore((1 - alpha/2) * 100);
        const zBeta = this.getZScore(power * 100);

        let n1;
        let parameters = {};

        if (type === 'means') {
            const mean1 = parseFloat(document.getElementById('mean1').value);
            const mean2 = parseFloat(document.getElementById('mean2').value);
            const commonStdDev = parseFloat(document.getElementById('commonStdDev').value);

            if (isNaN(mean1) || isNaN(mean2) || isNaN(commonStdDev) || commonStdDev <= 0) {
                throw new Error('Please enter valid numeric values for means and standard deviation');
            }

            n1 = this.calculateCompareMeans(mean1, mean2, commonStdDev, zAlpha, zBeta, ratio);
            parameters = { mean1, mean2, commonStdDev };
        } else {
            const prop1 = parseFloat(document.getElementById('prop1').value);
            const prop2 = parseFloat(document.getElementById('prop2').value);

            if (isNaN(prop1) || prop1 < 0 || prop1 > 1 || isNaN(prop2) || prop2 < 0 || prop2 > 1) {
                throw new Error('Proportions must be between 0 and 1');
            }

            n1 = this.calculateCompareProportions(prop1, prop2, zAlpha, zBeta, ratio);
            parameters = { prop1, prop2 };
        }

        const n2 = Math.ceil(n1 * ratio);

        return {
            group1Size: Math.ceil(n1),
            group2Size: n2,
            totalSize: Math.ceil(n1 + n2),
            type,
            alpha,
            power,
            ratio,
            parameters
        };
    }

    calculateCompareMeans(mean1, mean2, stdDev, zAlpha, zBeta, ratio) {
        const diff = Math.abs(mean1 - mean2);
        return ((1 + 1/ratio) * Math.pow(stdDev * (zAlpha + zBeta) / diff, 2));
    }

    calculateCompareProportions(p1, p2, zAlpha, zBeta, ratio) {
        const p = (p1 + ratio * p2) / (1 + ratio);
        const q = 1 - p;
        return (Math.pow(zAlpha * Math.sqrt((1 + 1/ratio) * p * q) + 
                zBeta * Math.sqrt(p1 * (1-p1) + (p2 * (1-p2))/ratio), 2)) / 
               Math.pow(p1 - p2, 2);
    }

    displayComparativeResults(results) {
        const resultHTML = `
            <div class="result-card">
                <h3>Comparative Study Sample Size Results</h3>
                
                <div class="result-section">
                    <h4>Required Sample Sizes</h4>
                    <p><strong>Group 1:</strong> ${results.group1Size} subjects</p>
                    <p><strong>Group 2:</strong> ${results.group2Size} subjects</p>
                    <p><strong>Total Sample Size:</strong> ${results.totalSize} subjects</p>
                </div>

                <div class="result-section">
                    <h4>Study Parameters</h4>
                    <p><strong>Comparison Type:</strong> ${results.type === 'means' ? 'Means' : 'Proportions'}</p>
                    ${results.type === 'means' ? `
                        <p><strong>Mean Difference:</strong> ${Math.abs(results.parameters.mean1 - results.parameters.mean2).toFixed(2)}</p>
                        <p><strong>Common SD:</strong> ${results.parameters.commonStdDev.toFixed(2)}</p>
                    ` : `
                        <p><strong>Proportion 1:</strong> ${(results.parameters.prop1 * 100).toFixed(1)}%</p>
                        <p><strong>Proportion 2:</strong> ${(results.parameters.prop2 * 100).toFixed(1)}%</p>
                    `}
                    <p><strong>Significance Level:</strong> ${results.alpha}</p>
                    <p><strong>Power:</strong> ${(results.power * 100).toFixed(1)}%</p>
                    <p><strong>Allocation Ratio:</strong> 1:${results.ratio}</p>
                </div>
            </div>
        `;
        this.resultsContainer.innerHTML = resultHTML;
    }
    // Part 3 ends here - Next part will implement Case-Control Study methods
     // Case-Control Study Methods
    getCaseControlForm() {
        return `
            <h3>Case-Control Study Calculator</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Expected Odds Ratio
                        <span class="tooltip" title="Minimum clinically important odds ratio to detect">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="oddsRatio" class="input-field" 
                           min="0.1" step="0.1" placeholder="e.g., 2.0" required>
                </div>

                <div class="input-group">
                    <label>Control Group Exposure
                        <span class="tooltip" title="Expected proportion of exposure in controls (0-1)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="controlExposure" class="input-field" 
                           step="0.01" min="0" max="1" placeholder="e.g., 0.3" required>
                </div>

                <div class="input-group">
                    <label>Case:Control Ratio
                        <span class="tooltip" title="Number of controls per case">‚ÑπÔ∏è</span>
                    </label>
                    <select id="caseControlRatio" class="input-field" required>
                        <option value="1">1:1 (Equal)</option>
                        <option value="0.5">1:2 (Twice controls)</option>
                        <option value="2">2:1 (Twice cases)</option>
                        <option value="0.25">1:4 (Four times controls)</option>
                        <option value="custom">Custom ratio</option>
                    </select>
                </div>

                <div class="input-group" id="customRatioGroup" style="display:none;">
                    <label>Custom Ratio Value
                        <span class="tooltip" title="Enter custom ratio">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="customRatio" class="input-field" 
                           min="0.1" step="0.1">
                </div>

                <div class="input-group">
                    <label>Significance Level (Œ±)
                        <span class="tooltip" title="Type I error rate (typically 0.05)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="alpha" class="input-field" 
                           value="0.05" step="0.01" min="0.01" max="0.1" required>
                </div>

                <div class="input-group">
                    <label>Power (1-Œ≤)
                        <span class="tooltip" title="Statistical power (typically 0.8 or 0.9)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="power" class="input-field" 
                           value="0.8" step="0.05" min="0.5" max="0.99" required>
                </div>

                <div class="input-group">
                    <label>Expected Dropout Rate (%)
                        <span class="tooltip" title="Expected percentage of dropouts">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="dropoutRate" class="input-field" 
                           value="10" min="0" max="50" step="1">
                </div>
            </div>

            <div class="advanced-options">
                <button type="button" id="showAdvanced" class="link-btn">Show Advanced Options ‚ñº</button>
                <div id="advancedOptions" style="display:none;">
                    <div class="input-group">
                        <label>Design Effect
                            <span class="tooltip" title="Adjustment for complex sampling (‚â•1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="designEffect" class="input-field" 
                               value="1" min="1" step="0.1">
                    </div>
                </div>
            </div>
            <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
        `;
    }

    setupCaseControlBehavior() {
        const ratioSelect = document.getElementById('caseControlRatio');
        const customRatioGroup = document.getElementById('customRatioGroup');
        const customRatio = document.getElementById('customRatio');
        const showAdvanced = document.getElementById('showAdvanced');
        const advancedOptions = document.getElementById('advancedOptions');

        if (ratioSelect) {
            ratioSelect.addEventListener('change', () => {
                if (ratioSelect.value === 'custom') {
                    customRatioGroup.style.display = 'block';
                    customRatio.required = true;
                } else {
                    customRatioGroup.style.display = 'none';
                    customRatio.required = false;
                }
            });
        }

        if (showAdvanced) {
            showAdvanced.addEventListener('click', () => {
                if (advancedOptions.style.display === 'none') {
                    advancedOptions.style.display = 'block';
                    showAdvanced.textContent = 'Hide Advanced Options ‚ñ≤';
                } else {
                    advancedOptions.style.display = 'none';
                    showAdvanced.textContent = 'Show Advanced Options ‚ñº';
                }
            });
        }
    }

    calculateCaseControlSampleSize() {
        const oddsRatio = parseFloat(document.getElementById('oddsRatio').value);
        const p0 = parseFloat(document.getElementById('controlExposure').value);
        let ratio = document.getElementById('caseControlRatio').value;
        if (ratio === 'custom') {
            ratio = parseFloat(document.getElementById('customRatio').value);
        } else {
            ratio = parseFloat(ratio);
        }
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        const dropoutRate = parseFloat(document.getElementById('dropoutRate').value) / 100;
        const designEffect = parseFloat(document.getElementById('designEffect')?.value || 1);

        // Validate inputs
        this.validateCaseControlInputs({oddsRatio, p0, ratio, alpha, power, dropoutRate});

        // Calculate z-scores
        const zAlpha = this.getZScore((1 - alpha/2) * 100);
        const zBeta = this.getZScore(power * 100);

        // Calculate p1 from odds ratio
        const p1 = (oddsRatio * p0) / (1 + p0 * (oddsRatio - 1));
        const q0 = 1 - p0;
        const q1 = 1 - p1;

        // Calculate base sample size
        let nCases = Math.pow(
            (zAlpha * Math.sqrt((1 + 1/ratio) * p0 * q0) + 
             zBeta * Math.sqrt(p1 * q1 + p0 * q0/ratio)), 2
        ) / Math.pow(p1 - p0, 2);

        // Apply design effect
        nCases *= designEffect;

        // Adjust for dropout
        nCases = nCases / (1 - dropoutRate);

        const nControls = nCases * ratio;

        return {
            cases: Math.ceil(nCases),
            controls: Math.ceil(nControls),
            totalSize: Math.ceil(nCases + nControls),
            oddsRatio,
            p0,
            p1,
            ratio,
            dropoutAdjusted: dropoutRate > 0,
            dropoutRate,
            designEffect
        };
    }

    validateCaseControlInputs(inputs) {
        const {oddsRatio, p0, ratio, alpha, power, dropoutRate} = inputs;
        
        let errors = [];

        if (oddsRatio <= 0) {
            errors.push("Odds ratio must be greater than 0");
        }

        if (p0 <= 0 || p0 >= 1) {
            errors.push("Control exposure proportion must be between 0 and 1");
        }

        if (ratio <= 0) {
            errors.push("Case:Control ratio must be greater than 0");
        }

        if (alpha <= 0 || alpha >= 1) {
            errors.push("Significance level must be between 0 and 1");
        }

        if (power <= 0 || power >= 1) {
            errors.push("Power must be between 0 and 1");
        }

        if (dropoutRate < 0 || dropoutRate >= 1) {
            errors.push("Dropout rate must be between 0 and 100%");
        }

        if (errors.length > 0) {
            throw new Error(errors.join("\n"));
        }
    }

    displayCaseControlResults(results) {
        const resultHTML = `
            <div class="result-card">
                <h3>Case-Control Study Sample Size Results</h3>
                
                <div class="result-section">
                    <h4>Required Sample Sizes</h4>
                    <p><strong>Number of Cases:</strong> ${results.cases}</p>
                    <p><strong>Number of Controls:</strong> ${results.controls}</p>
                    <p><strong>Total Sample Size:</strong> ${results.totalSize}</p>
                </div>
                
                <div class="result-section">
                    <h4>Study Parameters</h4>
                    <p><strong>Odds Ratio:</strong> ${results.oddsRatio.toFixed(2)}</p>
                    <p><strong>Control Exposure Rate:</strong> ${(results.p0 * 100).toFixed(1)}%</p>
                    <p><strong>Expected Case Exposure Rate:</strong> ${(results.p1 * 100).toFixed(1)}%</p>
                    <p><strong>Case:Control Ratio:</strong> 1:${results.ratio}</p>
                    ${results.dropoutAdjusted ? 
                        `<p><strong>Dropout Adjustment:</strong> ${(results.dropoutRate * 100).toFixed(1)}%</p>` : ''}
                    ${results.designEffect !== 1 ? 
                        `<p><strong>Design Effect:</strong> ${results.designEffect}</p>` : ''}
                </div>

                <div class="result-section">
                    <h4>Interpretation</h4>
                    <p>This sample size will provide sufficient power to detect an odds ratio of 
                       ${results.oddsRatio.toFixed(2)} or greater, assuming:</p>
                    <ul>
                        <li>A control exposure rate of ${(results.p0 * 100).toFixed(1)}%</li>
                        <li>${results.ratio === 1 ? 'Equal number of cases and controls' : 
                            `${results.ratio > 1 ? results.ratio : '1/' + (1/results.ratio)} controls per case`}</li>
                        ${results.dropoutAdjusted ? 
                            `<li>Accounting for ${(results.dropoutRate * 100).toFixed(1)}% potential dropouts</li>` : ''}
                    </ul>
                </div>
            </div>
        `;
        this.resultsContainer.innerHTML = resultHTML;
    }
    // Part 4 ends here - Next part will implement Cohort Study methods
     // Cohort Study Methods
    getCohortForm() {
        return `
            <h3>Cohort Study Calculator</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Study Design
                        <span class="tooltip" title="Select cohort study approach">‚ÑπÔ∏è</span>
                    </label>
                    <select id="cohortDesign" class="input-field" required>
                        <option value="risk">Risk-Based (Cumulative Incidence)</option>
                        <option value="rate">Rate-Based (Incidence Rate)</option>
                    </select>
                </div>

                <div id="riskInputs">
                    <div class="input-group">
                        <label>Expected Relative Risk (RR)
                            <span class="tooltip" title="Anticipated relative risk to detect">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="relativeRisk" class="input-field" 
                               min="0.1" step="0.1" placeholder="e.g., 2.0" required>
                    </div>

                    <div class="input-group">
                        <label>Risk in Unexposed Group (P0)
                            <span class="tooltip" title="Baseline risk in unexposed group (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="unexposedRisk" class="input-field" 
                               step="0.01" min="0" max="1" placeholder="e.g., 0.2" required>
                    </div>
                </div>

                <div id="rateInputs" style="display:none;">
                    <div class="input-group">
                        <label>Expected Rate Ratio (IRR)
                            <span class="tooltip" title="Anticipated incidence rate ratio">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="rateRatio" class="input-field" 
                               min="0.1" step="0.1" placeholder="e.g., 2.0">
                    </div>

                    <div class="input-group">
                        <label>Rate in Unexposed Group
                            <span class="tooltip" title="Baseline incidence rate per person-time">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="unexposedRate" class="input-field" 
                               min="0" step="0.001" placeholder="e.g., 0.05">
                    </div>

                    <div class="input-group">
                        <label>Follow-up Time (years)
                            <span class="tooltip" title="Duration of follow-up">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="followupTime" class="input-field" 
                               min="0.1" step="0.1" value="1">
                    </div>
                </div>

                <div class="input-group">
                    <label>Exposed:Unexposed Ratio
                        <span class="tooltip" title="Ratio of exposed to unexposed subjects">‚ÑπÔ∏è</span>
                    </label>
                    <select id="exposureRatio" class="input-field" required>
                        <option value="1">1:1 (Equal groups)</option>
                        <option value="0.5">1:2 (More unexposed)</option>
                        <option value="2">2:1 (More exposed)</option>
                        <option value="custom">Custom ratio</option>
                    </select>
                </div>

                <div class="input-group" id="customRatioGroup" style="display:none;">
                    <label>Custom Ratio Value
                        <span class="tooltip" title="Enter custom ratio value">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="customRatio" class="input-field" min="0.1" step="0.1">
                </div>

                <div class="input-group">
                    <label>Significance Level (Œ±)
                        <span class="tooltip" title="Type I error rate (typically 0.05)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="alpha" class="input-field" 
                           value="0.05" step="0.01" min="0.01" max="0.1" required>
                </div>

                <div class="input-group">
                    <label>Power (1-Œ≤)
                        <span class="tooltip" title="Statistical power (typically 0.8 or 0.9)">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="power" class="input-field" 
                           value="0.8" step="0.05" min="0.5" max="0.99" required>
                </div>

                <div class="input-group">
                    <label>Expected Loss to Follow-up (%)
                        <span class="tooltip" title="Expected dropout percentage">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="dropoutRate" class="input-field" 
                           value="10" min="0" max="50" step="1">
                </div>
            </div>

            <div class="advanced-options">
                <button type="button" id="showAdvanced" class="link-btn">Show Advanced Options ‚ñº</button>
                <div id="advancedOptions" style="display:none;">
                    <div class="input-group">
                        <label>Design Effect
                            <span class="tooltip" title="Adjustment for complex sampling (‚â•1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="designEffect" class="input-field" 
                               value="1" min="1" step="0.1">
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
        `;
    }

    setupCohortBehavior() {
        const cohortDesign = document.getElementById('cohortDesign');
        const riskInputs = document.getElementById('riskInputs');
        const rateInputs = document.getElementById('rateInputs');
        const exposureRatio = document.getElementById('exposureRatio');
        const customRatioGroup = document.getElementById('customRatioGroup');
        const showAdvanced = document.getElementById('showAdvanced');
        const advancedOptions = document.getElementById('advancedOptions');

        if (cohortDesign) {
            cohortDesign.addEventListener('change', () => {
                if (cohortDesign.value === 'risk') {
                    riskInputs.style.display = 'block';
                    rateInputs.style.display = 'none';
                    document.getElementById('relativeRisk').required = true;
                    document.getElementById('unexposedRisk').required = true;
                    document.getElementById('rateRatio').required = false;
                    document.getElementById('unexposedRate').required = false;
                } else {
                    riskInputs.style.display = 'none';
                    rateInputs.style.display = 'block';
                    document.getElementById('relativeRisk').required = false;
                    document.getElementById('unexposedRisk').required = false;
                    document.getElementById('rateRatio').required = true;
                    document.getElementById('unexposedRate').required = true;
                }
            });
        }

        if (exposureRatio) {
            exposureRatio.addEventListener('change', () => {
                if (exposureRatio.value === 'custom') {
                    customRatioGroup.style.display = 'block';
                    document.getElementById('customRatio').required = true;
                } else {
                    customRatioGroup.style.display = 'none';
                    document.getElementById('customRatio').required = false;
                }
            });
        }

        if (showAdvanced) {
            showAdvanced.addEventListener('click', () => {
                if (advancedOptions.style.display === 'none') {
                    advancedOptions.style.display = 'block';
                    showAdvanced.textContent = 'Hide Advanced Options ‚ñ≤';
                } else {
                    advancedOptions.style.display = 'none';
                    showAdvanced.textContent = 'Show Advanced Options ‚ñº';
                }
            });
        }
    }

    calculateCohortSampleSize() {
        const designType = document.getElementById('cohortDesign').value;
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        let ratio = document.getElementById('exposureRatio').value;
        if (ratio === 'custom') {
            ratio = parseFloat(document.getElementById('customRatio').value);
        } else {
            ratio = parseFloat(ratio);
        }
        const dropoutRate = parseFloat(document.getElementById('dropoutRate').value) / 100;
        const designEffect = parseFloat(document.getElementById('designEffect')?.value || 1);

        const zAlpha = this.getZScore((1 - alpha/2) * 100);
        const zBeta = this.getZScore(power * 100);

        let baseSize;
        let parameters = {};

        if (designType === 'risk') {
            const relativeRisk = parseFloat(document.getElementById('relativeRisk').value);
            const p0 = parseFloat(document.getElementById('unexposedRisk').value);
            const p1 = p0 * relativeRisk;

            baseSize = this.calculateRiskBasedSize(p0, p1, ratio, zAlpha, zBeta);
            parameters = { relativeRisk, p0, p1 };
        } else {
            const rateRatio = parseFloat(document.getElementById('rateRatio').value);
            const lambda0 = parseFloat(document.getElementById('unexposedRate').value);
            const followupTime = parseFloat(document.getElementById('followupTime').value);

            baseSize = this.calculateRateBasedSize(lambda0, rateRatio, followupTime, ratio, zAlpha, zBeta);
            parameters = { rateRatio, lambda0, followupTime };
        }

        // Apply design effect
        baseSize *= designEffect;

        // Adjust for dropout
        const adjustedSize = baseSize / (1 - dropoutRate);

        const unexposedSize = Math.ceil(adjustedSize);
        const exposedSize = Math.ceil(adjustedSize * ratio);

        return {
            unexposedSize,
            exposedSize,
            totalSize: unexposedSize + exposedSize,
            designType,
            parameters,
            ratio,
            dropoutRate,
            designEffect
        };
    }

    calculateRiskBasedSize(p0, p1, ratio, zAlpha, zBeta) {
        const q0 = 1 - p0;
        const q1 = 1 - p1;
        
        return ((Math.pow(zAlpha * Math.sqrt((1 + 1/ratio) * p0 * q0) + 
                zBeta * Math.sqrt(p1 * q1 + (p0 * q0)/ratio), 2)) / 
                Math.pow(p1 - p0, 2));
    }

    calculateRateBasedSize(lambda0, rateRatio, time, ratio, zAlpha, zBeta) {
        const lambda1 = lambda0 * rateRatio;
        
        return ((Math.pow(zAlpha * Math.sqrt((1 + 1/ratio) * lambda0) + 
                zBeta * Math.sqrt(lambda1 + lambda0/ratio), 2)) / 
                (time * Math.pow(lambda1 - lambda0, 2)));
    }

    displayCohortResults(results) {
        const resultHTML = `
            <div class="result-card">
                <h3>Cohort Study Sample Size Results</h3>
                
                <div class="result-section">
                    <h4>Required Sample Sizes</h4>
                    <p><strong>Exposed Group:</strong> ${results.exposedSize} subjects</p>
                    <p><strong>Unexposed Group:</strong> ${results.unexposedSize} subjects</p>
                    <p><strong>Total Sample Size:</strong> ${results.totalSize} subjects</p>
                </div>
                
                <div class="result-section">
                    <h4>Study Parameters</h4>
                    <p><strong>Study Design:</strong> ${results.designType === 'risk' ? 'Risk-Based' : 'Rate-Based'}</p>
                    ${results.designType === 'risk' ? `
                        <p><strong>Relative Risk:</strong> ${results.parameters.relativeRisk.toFixed(2)}</p>
                        <p><strong>Unexposed Risk:</strong> ${(results.parameters.p0 * 100).toFixed(1)}%</p>
                        <p><strong>Expected Exposed Risk:</strong> ${(results.parameters.p1 * 100).toFixed(1)}%</p>
                    ` : `
                        <p><strong>Rate Ratio:</strong> ${results.parameters.rateRatio.toFixed(2)}</p>
                        <p><strong>Unexposed Rate:</strong> ${results.parameters.lambda0.toFixed(3)} per person-year</p>
                        <p><strong>Follow-up Time:</strong> ${results.parameters.followupTime} years</p>
                    `}
                    <p><strong>Exposed:Unexposed Ratio:</strong> ${results.ratio}:1</p>
                    ${results.dropoutRate > 0 ? 
                        `<p><strong>Loss to Follow-up:</strong> ${(results.dropoutRate * 100).toFixed(1)}%</p>` : ''}
                    ${results.designEffect !== 1 ? 
                        `<p><strong>Design Effect:</strong> ${results.designEffect}</p>` : ''}
                </div>
                
                <div class="result-section">
                    <h4>Interpretation</h4>
                    <p>This sample size will provide sufficient power to detect ${
                        results.designType === 'risk' ? 
                        `a relative risk of ${results.parameters.relativeRisk.toFixed(2)}` :
                        `an incidence rate ratio of ${results.parameters.rateRatio.toFixed(2)}`
                    }, assuming:</p>
                    <ul>
                        <li>${results.designType === 'risk' ? 
                            `A baseline risk of ${(results.parameters.p0 * 100).toFixed(1)}% in the unexposed group` :
                            `A baseline rate of ${results.parameters.lambda0.toFixed(3)} per person-year in the unexposed group`
                        }</li>
                        <li>${results.ratio === 1 ? 'Equal group sizes' : 
                            `${results.ratio}:1 ratio of exposed to unexposed subjects`}</li>
                        ${results.dropoutRate > 0 ? 
                            `<li>${(results.dropoutRate * 100).toFixed(1)}% loss to follow-up</li>` : ''}
                    </ul>
                </div>
            </div>
        `;
        this.resultsContainer.innerHTML = resultHTML;
    }
    // Part 5 ends here - Next part will implement Clinical Trial methods
     // Clinical Trial Methods
    getClinicalTrialForm() {
        return `
            <h3>Clinical Trial Sample Size Calculator</h3>
            <div class="form-grid">
                <div class="input-group">
                    <label>Trial Type
                        <span class="tooltip" title="Select the type of clinical trial">‚ÑπÔ∏è</span>
                    </label>
                    <select id="trialType" class="input-field" required>
                        <option value="superiority">Superiority Trial</option>
                        <option value="noninferiority">Non-Inferiority Trial</option>
                        <option value="equivalence">Equivalence Trial</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Outcome Type
                        <span class="tooltip" title="Type of primary outcome measure">‚ÑπÔ∏è</span>
                    </label>
                    <select id="outcomeType" class="input-field" required>
                        <option value="binary">Binary (Success/Failure)</option>
                        <option value="continuous">Continuous (Measurement)</option>
                        <option value="survival">Time-to-Event (Survival)</option>
                    </select>
                </div>

                <!-- Binary Outcome Inputs -->
                <div id="binaryInputs" style="display:none;">
                    <div class="input-group">
                        <label>Control Group Success Rate
                            <span class="tooltip" title="Expected success rate in control group (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="controlRate" class="input-field" 
                               step="0.01" min="0" max="1" placeholder="e.g., 0.5">
                    </div>
                    <div class="input-group">
                        <label>Expected Treatment Success Rate
                            <span class="tooltip" title="Expected success rate in treatment group (0-1)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="treatmentRate" class="input-field" 
                               step="0.01" min="0" max="1" placeholder="e.g., 0.65">
                    </div>
                </div>

                <!-- Continuous Outcome Inputs -->
                <div id="continuousInputs" style="display:none;">
                    <div class="input-group">
                        <label>Expected Difference in Means
                            <span class="tooltip" title="Clinically important difference to detect">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="meanDifference" class="input-field" step="any">
                    </div>
                    <div class="input-group">
                        <label>Expected Standard Deviation
                            <span class="tooltip" title="Common standard deviation for both groups">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="stdDev" class="input-field" min="0" step="any">
                    </div>
                </div>

                <!-- Survival Outcome Inputs -->
                <div id="survivalInputs" style="display:none;">
                    <div class="input-group">
                        <label>Control Group Hazard Rate
                            <span class="tooltip" title="Baseline hazard rate in control group">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="controlHazard" class="input-field" min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Expected Hazard Ratio
                            <span class="tooltip" title="Anticipated hazard ratio (treatment/control)">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="hazardRatio" class="input-field" min="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Study Duration (years)
                            <span class="tooltip" title="Total study duration">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="studyDuration" class="input-field" min="0" step="0.5">
                    </div>
                </div>

                <!-- Non-Inferiority/Equivalence Margin -->
                <div id="marginInput" style="display:none;">
                    <div class="input-group">
                        <label>Non-Inferiority/Equivalence Margin
                            <span class="tooltip" title="Acceptable difference from control">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="margin" class="input-field" step="any">
                    </div>
                </div>

                <div class="input-group">
                    <label>Significance Level (Œ±)
                        <span class="tooltip" title="Type I error rate">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="alpha" class="input-field" 
                           value="0.05" step="0.001" min="0.001" max="0.1" required>
                </div>

                <div class="input-group">
                    <label>Power (1-Œ≤)
                        <span class="tooltip" title="Statistical power">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="power" class="input-field" 
                           value="0.8" step="0.05" min="0.5" max="0.99" required>
                </div>

                <div class="input-group">
                    <label>Allocation Ratio (Treatment:Control)
                        <span class="tooltip" title="Ratio of subjects in treatment vs control">‚ÑπÔ∏è</span>
                    </label>
                    <select id="allocationRatio" class="input-field" required>
                        <option value="1">1:1 (Equal)</option>
                        <option value="2">2:1</option>
                        <option value="0.5">1:2</option>
                        <option value="custom">Custom ratio</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>Expected Dropout Rate (%)
                        <span class="tooltip" title="Expected percentage of dropouts">‚ÑπÔ∏è</span>
                    </label>
                    <input type="number" id="dropoutRate" class="input-field" 
                           value="10" min="0" max="50" step="1">
                </div>
            </div>

            <div class="advanced-options">
                <button type="button" id="showAdvanced" class="link-btn">Show Advanced Options ‚ñº</button>
                <div id="advancedOptions" style="display:none;">
                    <div class="input-group">
                        <label>Interim Analyses
                            <span class="tooltip" title="Number of planned interim analyses">‚ÑπÔ∏è</span>
                        </label>
                        <input type="number" id="interimAnalyses" class="input-field" 
                               value="0" min="0" max="5" step="1">
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
        `;
    }

    setupClinicalTrialBehavior() {
        const trialType = document.getElementById('trialType');
        const outcomeType = document.getElementById('outcomeType');
        const binaryInputs = document.getElementById('binaryInputs');
        const continuousInputs = document.getElementById('continuousInputs');
        const survivalInputs = document.getElementById('survivalInputs');
        const marginInput = document.getElementById('marginInput');
        const showAdvanced = document.getElementById('showAdvanced');
        const advancedOptions = document.getElementById('advancedOptions');

        // Trial type behavior
        if (trialType) {
            trialType.addEventListener('change', () => {
                const isNonInferiority = trialType.value === 'noninferiority' || trialType.value === 'equivalence';
                marginInput.style.display = isNonInferiority ? 'block' : 'none';
                document.getElementById('alpha').value = isNonInferiority ? '0.025' : '0.05';
            });
        }

        // Outcome type behavior
        if (outcomeType) {
            outcomeType.addEventListener('change', () => {
                binaryInputs.style.display = 'none';
                continuousInputs.style.display = 'none';
                survivalInputs.style.display = 'none';

                switch(outcomeType.value) {
                    case 'binary':
                        binaryInputs.style.display = 'block';
                        break;
                    case 'continuous':
                        continuousInputs.style.display = 'block';
                        break;
                    case 'survival':
                        survivalInputs.style.display = 'block';
                        break;
                }
            });
        }

        // Advanced options behavior
        if (showAdvanced) {
            showAdvanced.addEventListener('click', () => {
                if (advancedOptions.style.display === 'none') {
                    advancedOptions.style.display = 'block';
                    showAdvanced.textContent = 'Hide Advanced Options ‚ñ≤';
                } else {
                    advancedOptions.style.display = 'none';
                    showAdvanced.textContent = 'Show Advanced Options ‚ñº';
                }
            });
        }
    }

    calculateClinicalTrialSampleSize() {
        const trialType = document.getElementById('trialType').value;
        const outcomeType = document.getElementById('outcomeType').value;
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        const dropoutRate = parseFloat(document.getElementById('dropoutRate').value) / 100;
        const interimAnalyses = parseInt(document.getElementById('interimAnalyses').value);
        
        let baseSize;
        let parameters = {};
        
        // Calculate base sample size based on outcome type
        switch(outcomeType) {
            case 'binary':
                baseSize = this.calculateBinaryClinicalTrial(trialType);
                break;
            case 'continuous':
                baseSize = this.calculateContinuousClinicalTrial(trialType);
                break;
            case 'survival':
                baseSize = this.calculateSurvivalClinicalTrial();
                break;
            default:
                throw new Error('Invalid outcome type');
        }

        // Adjust for interim analyses
        if (interimAnalyses > 0) {
            baseSize = this.adjustForInterimAnalyses(baseSize, interimAnalyses);
        }

        // Adjust for dropouts
        const adjustedSize = Math.ceil(baseSize / (1 - dropoutRate));

        return {
            baseSize: Math.ceil(baseSize),
            adjustedSize,
            perGroup: Math.ceil(adjustedSize / 2),
            trialType,
            outcomeType,
            parameters,
            dropoutRate,
            interimAnalyses
        };
    }

    calculateBinaryClinicalTrial(trialType) {
        const p1 = parseFloat(document.getElementById('controlRate').value);
        const p2 = parseFloat(document.getElementById('treatmentRate').value);
        const margin = document.getElementById('margin')?.value ? 
            parseFloat(document.getElementById('margin').value) : 0;
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        
        const zAlpha = this.getZScore((1 - alpha) * 100);
        const zBeta = this.getZScore(power * 100);
        
        let n;
        switch(trialType) {
            case 'superiority':
                n = this.calculateSuperiorityTrial(p1, p2, zAlpha, zBeta);
                break;
            case 'noninferiority':
                n = this.calculateNonInferiorityTrial(p1, p2, margin, zAlpha, zBeta);
                break;
            case 'equivalence':
                n = this.calculateEquivalenceTrial(p1, p2, margin, zAlpha, zBeta);
                break;
        }
        return n * 2; // Total sample size for both groups
    }

    calculateContinuousClinicalTrial(trialType) {
        const diff = parseFloat(document.getElementById('meanDifference').value);
        const sd = parseFloat(document.getElementById('stdDev').value);
        const margin = document.getElementById('margin')?.value ? 
            parseFloat(document.getElementById('margin').value) : 0;
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        
        const zAlpha = this.getZScore((1 - alpha) * 100);
        const zBeta = this.getZScore(power * 100);
        
        let n;
        switch(trialType) {
            case 'superiority':
                n = 2 * Math.pow(sd * (zAlpha + zBeta) / diff, 2);
                break;
            case 'noninferiority':
                n = 2 * Math.pow(sd * (zAlpha + zBeta) / (diff - margin), 2);
                break;
            case 'equivalence':
                n = 2 * Math.pow(sd * (zAlpha + zBeta) / margin, 2);
                break;
        }
        return n * 2;
    }

    calculateSurvivalClinicalTrial() {
        const hazardRatio = parseFloat(document.getElementById('hazardRatio').value);
        const controlHazard = parseFloat(document.getElementById('controlHazard').value);
        const duration = parseFloat(document.getElementById('studyDuration').value);
        const alpha = parseFloat(document.getElementById('alpha').value);
        const power = parseFloat(document.getElementById('power').value);
        
        const zAlpha = this.getZScore((1 - alpha) * 100);
        const zBeta = this.getZScore(power * 100);
        
        const events = Math.pow(zAlpha + zBeta, 2) / Math.pow(Math.log(hazardRatio), 2);
        return events / (controlHazard * duration);
    }

    adjustForInterimAnalyses(baseSize, analyses) {
        // O'Brien-Fleming adjustment
        const inflationFactor = 1 + (analyses * 0.028);
        return baseSize * inflationFactor;
    }
    displayClinicalTrialResults(results) {
        const resultHTML = `
            <div class="result-card">
                <h3>Clinical Trial Sample Size Results</h3>
                
                <div class="result-section">
                    <h4>Required Sample Sizes</h4>
                    <p><strong>Total Sample Size:</strong> ${results.adjustedSize} subjects</p>
                    <p><strong>Per Group:</strong> ${results.perGroup} subjects</p>
                    <p><strong>Base Sample Size:</strong> ${results.baseSize} subjects</p>
                </div>

                <div class="result-section">
                    <h4>Trial Parameters</h4>
                    <p><strong>Trial Type:</strong> ${results.trialType.charAt(0).toUpperCase() + results.trialType.slice(1)}</p>
                    <p><strong>Outcome Type:</strong> ${results.outcomeType.charAt(0).toUpperCase() + results.outcomeType.slice(1)}</p>
                    ${results.parameters.hasOwnProperty('controlRate') ? `
                        <p><strong>Control Success Rate:</strong> ${(results.parameters.controlRate * 100).toFixed(1)}%</p>
                        <p><strong>Treatment Success Rate:</strong> ${(results.parameters.treatmentRate * 100).toFixed(1)}%</p>
                    ` : ''}
                    ${results.parameters.hasOwnProperty('meanDifference') ? `
                        <p><strong>Expected Difference:</strong> ${results.parameters.meanDifference.toFixed(2)}</p>
                        <p><strong>Standard Deviation:</strong> ${results.parameters.stdDev.toFixed(2)}</p>
                    ` : ''}
                    ${results.parameters.hasOwnProperty('hazardRatio') ? `
                        <p><strong>Hazard Ratio:</strong> ${results.parameters.hazardRatio.toFixed(2)}</p>
                        <p><strong>Study Duration:</strong> ${results.parameters.duration} years</p>
                    ` : ''}
                    ${results.parameters.hasOwnProperty('margin') ? `
                        <p><strong>Non-inferiority/Equivalence Margin:</strong> ${results.parameters.margin.toFixed(3)}</p>
                    ` : ''}
                </div>

                <div class="result-section">
                    <h4>Adjustments</h4>
                    ${results.dropoutRate > 0 ? `
                        <p><strong>Dropout Rate:</strong> ${(results.dropoutRate * 100).toFixed(1)}%</p>
                    ` : ''}
                    ${results.interimAnalyses > 0 ? `
                        <p><strong>Interim Analyses:</strong> ${results.interimAnalyses}</p>
                    ` : ''}
                </div>

                <div class="result-section">
                    <h4>Interpretation</h4>
                    <p>This sample size will provide sufficient power to ${this.getInterpretationText(results)}</p>
                    <ul>
                        <li>Equal allocation between treatment and control groups</li>
                        ${results.dropoutRate > 0 ? 
                            `<li>Accounts for ${(results.dropoutRate * 100).toFixed(1)}% dropout rate</li>` : ''}
                        ${results.interimAnalyses > 0 ? 
                            `<li>Adjusted for ${results.interimAnalyses} planned interim ${
                                results.interimAnalyses === 1 ? 'analysis' : 'analyses'}</li>` : ''}
                    </ul>
                </div>
            </div>
        `;
        this.resultsContainer.innerHTML = resultHTML;
    }

    getInterpretationText(results) {
        switch(results.trialType) {
            case 'superiority':
                return 'demonstrate superiority of the treatment over control';
            case 'noninferiority':
                return 'demonstrate that the treatment is not inferior to control';
            case 'equivalence':
                return 'demonstrate therapeutic equivalence between treatment and control';
            default:
                return 'evaluate the treatment effect';
        }
    }
    // Diagnostic Study methods
    getDiagnosticStudyForm() {
    return `
        <h3>Diagnostic Study Calculator</h3>
        <div class="form-grid">
            <div class="input-group">
                <label>Primary Objective
                    <span class="tooltip" title="Select primary estimation goal">‚ÑπÔ∏è</span>
                </label>
                <select id="primaryObjective" class="input-field" required>
                    <option value="both">Both Sensitivity & Specificity</option>
                    <option value="sensitivity">Sensitivity Only</option>
                    <option value="specificity">Specificity Only</option>
                </select>
            </div>

            <div class="input-group">
                <label>Expected Sensitivity (%)
                    <span class="tooltip" title="Anticipated sensitivity of the test">‚ÑπÔ∏è</span>
                </label>
                <input type="number" id="sensitivity" class="input-field" 
                       min="1" max="100" step="0.1" value="80" required>
            </div>

            <div class="input-group">
                <label>Expected Specificity (%)
                    <span class="tooltip" title="Anticipated specificity of the test">‚ÑπÔ∏è</span>
                </label>
                <input type="number" id="specificity" class="input-field" 
                       min="1" max="100" step="0.1" value="90" required>
            </div>

            <div class="input-group">
                <label>Disease Prevalence (%)
                    <span class="tooltip" title="Expected prevalence in study population">‚ÑπÔ∏è</span>
                </label>
                <input type="number" id="prevalence" class="input-field" 
                       min="0.1" max="99.9" step="0.1" value="10" required>
            </div>

            <div class="input-group">
                <label>Desired Precision (¬±)
                    <span class="tooltip" title="Maximum acceptable margin of error">‚ÑπÔ∏è</span>
                </label>
                <input type="number" id="precision" class="input-field" 
                       min="1" max="20" step="0.5" value="5" required>
            </div>

            <div class="input-group">
                <label>Confidence Level (%)
                    <span class="tooltip" title="Typically 95% or 99%">‚ÑπÔ∏è</span>
                </label>
                <input type="number" id="confidenceLevel" class="input-field" 
                       value="95" min="80" max="99.9" step="0.1" required>
            </div>
        </div>
        <button type="submit" class="calculate-btn">Calculate Sample Size ‚ú®</button>
    `;
}

setupDiagnosticBehavior() {
    // Add any specific behavior for diagnostic study inputs
}

calculateDiagnosticSampleSize() {
    const sensitivity = parseFloat(document.getElementById('sensitivity').value) / 100;
    const specificity = parseFloat(document.getElementById('specificity').value) / 100;
    const prevalence = parseFloat(document.getElementById('prevalence').value) / 100;
    const precision = parseFloat(document.getElementById('precision').value) / 100;
    const confidenceLevel = parseFloat(document.getElementById('confidenceLevel').value);
    
    const zScore = this.getZScore(confidenceLevel);
    
    // Calculate sample sizes for sensitivity and specificity
    const nSensitivity = this.calculateSensitivitySampleSize(sensitivity, precision, zScore, prevalence);
    const nSpecificity = this.calculateSpecificitySampleSize(specificity, precision, zScore, prevalence);
    
    const totalSize = Math.max(nSensitivity, nSpecificity);
    
    return {
        totalSize: Math.ceil(totalSize),
        diseasePositive: Math.ceil(totalSize * prevalence),
        diseaseNegative: Math.ceil(totalSize * (1 - prevalence)),
        sensitivity,
        specificity,
        prevalence,
        precision
    };
}

calculateSensitivitySampleSize(sensitivity, precision, zScore, prevalence) {
    return (Math.pow(zScore, 2) * sensitivity * (1 - sensitivity)) / 
           (Math.pow(precision, 2) * prevalence);
}

calculateSpecificitySampleSize(specificity, precision, zScore, prevalence) {
    return (Math.pow(zScore, 2) * specificity * (1 - specificity)) / 
           (Math.pow(precision, 2) * (1 - prevalence));
}

displayDiagnosticResults(results) {
    const resultHTML = `
        <div class="result-card">
            <h3>Diagnostic Study Sample Size Results</h3>
            
            <div class="result-section">
                <h4>Required Sample Sizes</h4>
                <p><strong>Total Sample Size:</strong> ${results.totalSize} subjects</p>
                <p><strong>Disease Positive:</strong> ${results.diseasePositive} subjects</p>
                <p><strong>Disease Negative:</strong> ${results.diseaseNegative} subjects</p>
            </div>
            
            <div class="result-section">
                <h4>Test Parameters</h4>
                <p><strong>Sensitivity:</strong> ${(results.sensitivity * 100).toFixed(1)}%</p>
                <p><strong>Specificity:</strong> ${(results.specificity * 100).toFixed(1)}%</p>
                <p><strong>Disease Prevalence:</strong> ${(results.prevalence * 100).toFixed(1)}%</p>
                <p><strong>Precision:</strong> ¬±${(results.precision * 100).toFixed(1)}%</p>
            </div>
        </div>
    `;
    this.resultsContainer.innerHTML = resultHTML;
}
    // Initialize the calculator when the document is ready
    static initialize() {
        document.addEventListener('DOMContentLoaded', () => {
            window.calculator = new SampleSizeCalculator();
        });
    }
}

// Initialize the calculator
SampleSizeCalculator.initialize();
</script>
</body>
</html>
